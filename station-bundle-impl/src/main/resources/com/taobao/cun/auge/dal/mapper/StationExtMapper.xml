<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.taobao.cun.auge.dal.mapper.StationExtMapper">
  <resultMap id="BaseResultMap" type="com.taobao.cun.auge.dal.domain.Station">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 15 12:43:49 CST 2016.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="gmt_create" jdbcType="TIMESTAMP" property="gmtCreate" />
    <result column="gmt_modified" jdbcType="TIMESTAMP" property="gmtModified" />
    <result column="creater" jdbcType="VARCHAR" property="creater" />
    <result column="modifier" jdbcType="VARCHAR" property="modifier" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="alipay_account" jdbcType="VARCHAR" property="alipayAccount" />
    <result column="taobao_nick" jdbcType="VARCHAR" property="taobaoNick" />
    <result column="state" jdbcType="VARCHAR" property="state" />
    <result column="is_deleted" jdbcType="CHAR" property="isDeleted" />
    <result column="province" jdbcType="VARCHAR" property="province" />
    <result column="city" jdbcType="VARCHAR" property="city" />
    <result column="county" jdbcType="VARCHAR" property="county" />
    <result column="town" jdbcType="VARCHAR" property="town" />
    <result column="province_detail" jdbcType="VARCHAR" property="provinceDetail" />
    <result column="city_detail" jdbcType="VARCHAR" property="cityDetail" />
    <result column="county_detail" jdbcType="VARCHAR" property="countyDetail" />
    <result column="town_detail" jdbcType="VARCHAR" property="townDetail" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="apply_org" jdbcType="BIGINT" property="applyOrg" />
    <result column="taobao_user_id" jdbcType="BIGINT" property="taobaoUserId" />
    <result column="station_num" jdbcType="VARCHAR" property="stationNum" />
    <result column="lng" jdbcType="VARCHAR" property="lng" />
    <result column="lat" jdbcType="VARCHAR" property="lat" />
    <result column="village" jdbcType="VARCHAR" property="village" />
    <result column="village_detail" jdbcType="VARCHAR" property="villageDetail" />
    <result column="covered" jdbcType="VARCHAR" property="covered" />
    <result column="products" jdbcType="VARCHAR" property="products" />
    <result column="logistics_state" jdbcType="VARCHAR" property="logisticsState" />
    <result column="format" jdbcType="VARCHAR" property="format" />
    <result column="area_type" jdbcType="VARCHAR" property="areaType" />
    <result column="manager_id" jdbcType="VARCHAR" property="managerId" />
    <result column="provider_id" jdbcType="BIGINT" property="providerId" />
    <result column="feature" jdbcType="VARCHAR" property="feature" />
    <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="fixed_type" jdbcType="VARCHAR" property="fixedType" />
    <result column="version" jdbcType="BIGINT" property="version" />
  </resultMap>

  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Fri Jul 15 12:43:49 CST 2016.
    -->
    id, gmt_create, gmt_modified, creater, modifier, name, description, alipay_account, 
    taobao_nick, state, is_deleted, province, city, county, town, province_detail, city_detail, 
    county_detail, town_detail, address, apply_org, taobao_user_id, station_num, lng, 
    lat, village, village_detail, covered, products, logistics_state, format, area_type, 
    manager_id, provider_id, feature, status, fixed_type, version
  </sql>


  <select id="getTpStationsByName" parameterType="com.taobao.cun.auge.dal.example.StationExtExample" resultMap="BaseResultMap">
    select
    distinct
    s.id,
    s.name,
    s.station_num
    from station s, cuntao_org org, partner_station_rel p
    where s.apply_org = org.id and s.is_deleted='n' and org.is_deleted='n' and p.station_id = s.id and p.type = 'TP' and p.is_deleted='n'
    <if test="orgIdPath != null and orgIdPath != ''" >
      and concat(org.temp_full_id_path, '/') like concat(#{orgIdPath,jdbcType=VARCHAR}, '/%')
    </if>
    <if test="status != null and status != ''" >
      and s.status = #{status,jdbcType=VARCHAR}
    </if>
    <if test="name != null and name != ''" >
      and LOCATE(#{name,jdbcType=VARCHAR},s.name)>0
    </if>
    <if test="pageSize != null and pageSize != ''" >
      limit #{pageStart,jdbcType=INTEGER} , #{pageSize,jdbcType=INTEGER}
    </if>
  </select>
  
	<select id="selectByExample" parameterType="com.taobao.cun.auge.dal.example.StationExtExample" resultMap="BaseResultMap">
		select
    		s.*
			from station s
		<if test="type != null and type != ''">
			, partner_station_rel p
		</if>
			
		<if test="orgIdPath != null and orgIdPath != ''" >
			, cuntao_org org
		</if>
			where s.is_deleted='n' 
		<if test="type != null and type != ''">
			and p.is_deleted='n' and p.station_id = s.id and p.is_current='y'
		</if>
		<if test="orgIdPath != null and orgIdPath != ''" >
			and org.is_deleted='n' and s.apply_org = org.id
		</if>
		<if test="statuses != null" >
			and s.status in
			<foreach item="item" collection="statuses" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
	    <if test="status != null and status != ''" >
	      and s.status = #{status,jdbcType=VARCHAR}
	    </if>
		<if test="type != null and type != ''">
			and p.type = #{type,jdbcType=VARCHAR}
		</if>
		<if test="orgId != null">
			and s.apply_org = #{orgId,jdbcType=BIGINT}
		</if>
		<if test="orgIdPath != null and orgIdPath != ''" >
	      and concat(org.temp_full_id_path, '/') like concat(#{orgIdPath,jdbcType=VARCHAR}, '/%')
	    </if>
	    <if test="name != null and name != ''" >
	      and LOCATE(#{name,jdbcType=VARCHAR},s.name)>0
	    </if>
	</select>

    <select id="getFenceTemplateStation" resultType="com.taobao.cun.auge.fence.dto.FenceTemplateStation">
        select
        s.id as stationId,
        f.template_id as templateId,
        s.name as name
        from station s, fence_entity f
        where s.id = f.station_id
        and f.template_id = #{templateId}
        <if test="stationName != null and stationName != ''" >
            and s.name like concat('%', #{stationName,jdbcType=VARCHAR}, '%')
        </if>
        and s.is_deleted = 'n'
        and f.is_deleted = 'n'
    </select>
    
    <select id="getFenceStations" parameterType="com.taobao.cun.auge.station.bo.dto.FenceStationQueryCondition" resultMap="com.taobao.cun.auge.dal.mapper.StationMapper.BaseResultMap">
    select a.* from station a, cuntao_org b,partner_station_rel c 
     where a.is_deleted='n' and b.is_deleted='n' and c.is_deleted='n' and a.apply_org=b.id and a.id=c.station_id
	<if test="fullIdPath != null"> and b.temp_full_id_path like concat(#{fullIdPath,jdbcType=VARCHAR}, '%')</if>
	<if test="province != null"> and a.province=#{province,jdbcType=VARCHAR}</if>
	<if test="city != null"> and a.city=#{city,jdbcType=VARCHAR}</if>
	<if test="county != null"> and a.county=#{county,jdbcType=VARCHAR}</if>
	<if test="town != null"> and a.town=#{town,jdbcType=VARCHAR}</if>
	
	<if test="stationTypes != null"> and 
		<foreach collection="stationTypes" open="(" close=")" item="type" separator=" or ">
			<if test="type == 'TP'">
				c.type='TP'
			</if>
			<if test="type == 'TPS'">
				c.type='TPS'
			</if>
			<if test="type == 'TP_v4'">
				c.type='TP' and c.mode='v4'
			</if>
		</foreach>
	</if>
	<if test="stationStatus != null"> and c.state in
		<foreach collection="stationStatus" open="(" close=")" item="status" separator=","> #{status}</foreach>
	</if>
	<if test="stationLocations != null"> and 
		<foreach collection="stationLocations" open="(" close=")" item="stationLocation" separator=" or ">
			<if test="stationLocation == 'town'">
			a.is_on_town = 'y'
			</if>
			<if test="stationLocation == 'village'">
			(a.is_on_town = 'n' or a.is_on_town is null)
			</if>
		</foreach>
	</if>
    </select>
</mapper>