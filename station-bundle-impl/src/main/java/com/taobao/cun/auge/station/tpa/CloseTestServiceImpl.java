package com.taobao.cun.auge.station.tpa;

import java.util.Iterator;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.google.common.collect.Lists;
import com.taobao.cun.auge.partner.service.PartnerAssetService;
import com.taobao.cun.auge.station.condition.PartnerInstanceCondition;
import com.taobao.cun.auge.station.dto.PartnerInstanceDto;
import com.taobao.cun.auge.station.dto.PartnerLifecycleDto;
import com.taobao.cun.auge.station.enums.OperatorTypeEnum;
import com.taobao.cun.auge.station.service.PartnerInstanceQueryService;
import com.taobao.hsf.app.spring.util.annotation.HSFProvider;
@Service("closeTestService")
@HSFProvider(serviceInterface = CloseTestService.class, clientTimeout = 7000)
public class CloseTestServiceImpl implements CloseTestService {
	private static final String stationIds = "602,1142,1439,1790,3086,4814,5651,5678,6650,7271,7541,7757,7811,8270,8324,8648,8783,9242,9431,9836,9917,9998,10079,10349,10511,10700,10997,11051,11105,11240,11294,11780,11807,12293,12509,13130,13562,14588,15479,15587,15614,15884,16316,16802,16991,17558,17747,17963,19286,21203,21689,21716,22229,23552,23687,23741,23822,29303,29600,30977,38267,40157,44720,49229,56762,60164,61217,61703,61865,62027,64538,67076,67184,72098,73151,73394,73664,76715,77012,79685,80090,80630,80711,82439,83060,83438,88487,770,1256,1337,1607,2309,2390,3848,3929,4280,5441,6062,6791,7763,8087,8762,8870,9545,9869,10463,10868,10895,11273,11489,11759,12245,13109,13163,13244,13379,13757,13973,14027,14162,14729,15485,16025,16133,16187,16349,16565,16727,17483,17807,17861,18023,18671,19373,20237,21047,21263,21803,22100,23018,23045,23747,23828,24179,25016,26015,26609,30443,33359,42944,43619,46508,51773,51854,53906,54446,54932,55175,56795,57011,58712,59117,61871,62168,64058,64220,64490,68000,69053,69863,74399,79124,79718,80717,81122,85307,87494,87602,89546,93488,98645,102047,768,1173,1227,1389,1632,2793,3549,3576,4062,5250,5574,5736,6141,6681,7113,7626,7788,7869,7950,8031,8193,8274,8733,8760,9030,9192,9570,10299,10488,11676,11838,12351,12594,14187,14241,15294,15510,16779,16941,17562,22260,23151,24339,25905,26850,29253,29766,31359,40215,41754,45210,49071,49206,50961,51393,52392,52419,53094,54390,55389,56037,62085,62193,66540,69807,71319,72075,74073,75639,75855,78474,79743,80742,80769,81417,82173,82929,87546,90543,92028,1178,1340,2258,2825,3068,3176,3770,4013,6227,6254,6875,7577,7766,8090,8306,8495,8765,9926,10682,11033,11249,11816,12140,12464,13139,13949,14435,15569,15866,16622,16811,16838,17135,17513,17729,18350,19079,19673,20024,21374,21482,21671,22454,22481,23696,23750,24506,24803,24911,25289,27503,28880,42164,47402,48077,50615,55934,58904,61010,61712,62468,66545,68948,71108,73025,75347,77939,78398,79424,79829,81692,82070,87821,649,1000,1621,1945,2188,2377,3511,3646,3997,5671,6211,6265,6832,6859,7237,8128,8236,8317,8371,8560,9019,9802,10072,10261,11206,11287,11854,12529,12556,12745,12934,13447,13744,13879,14257,15931,16093,16552,16903,17281,17389,17578,18604,18766,19576,20845,21358,21736,22087,22276,23167,23410,23734,24220,24409,30997,31618,36451,43849,45739,45901,46522,47494,48412,49681,56350,58294,61156,64963,66448,69364,71848,74764,75979,76357,76519,78409,79489,80299,80569,89263,106,808,970,1240,1402,1672,2077,2266,2644,5128,5236,5668,5749,6775,7018,7045,7531,7558,7693,8314,8557,8611,8989,9097,9340,9448,9556,10177,10204,10339,11041,11068,11230,11419,11527,11554,11851,12445,12634,12796,12877,13147,13795,13876,14119,14686,14848,15550,17845,17980,18061,19006,19168,20761,21382,21814,22084,22381,22435,22462,23272,23704,26080,28915,29806,32668,36394,41200,41767,42955,43009,45493,45736,47734,51379,53809,53971,54862,54916,56617,57751,58372,61666,62287,62476,63691,65743,68902,69415,69604,72763,75004,75409,75706,76219,76813,76921,77596,78730,79864,84184,85048,86236,93121,1114,1357,2113,2356,3625,3733,3895,5461,5677,6217,6649,6757,7027,7567,7972,8107,8188,8404,10375,10645,11401,11455,11644,12265,12643,12724,13075,13291,13345,13615,13642,14128,14398,14668,14803,15316,15667,15802,16126,19069,21364,21769,22417,22579,22687,22849,22957,23470,23659,24199,24226,24496,25009,25225,25306,25846,26197,26467,28303,41398,42559,42937,43666,45637,48202,48985,51631,52873,53710,55114,59191,62863,63376,64105,64672,66724,69127,71800,71989,74257,76444,78442,78577,78928,79441,81655,82762,85597,85948,87946,88216,90970,92320,93805,94777,431,647,1295,1538,2321,2780,3644,4805,5534,5561,6695,6749,7181,7721,8099,8315,8531,8612,8774,8882,9206,9557,10016,10070,10097,10502,10556,11042,11231,12095,12581,12851,12905,13013,13526,13661,14282,15065,15281,15362,15686,15767,15821,16415,16658,17333,17765,19115,19682,20087,21491,21653,22382,22490,22868,23111,23759,24623,24866,25676,26864,26918,27296,36422,46466,46493,47843,50624,50678,53243,53783,54404,58589,61559,61964,63989,64367,71063,71792,72197,73520,74465,74519,77678,79163,79622,79757,81539,82241,87101,89666,93284,94526,1613,2855,3125,3611,4043,4799,5447,6041,6068,6797,6932,7094,7283,7553,7607,7823,8525,9470,9902,9983,10442,11441,11630,11765,11981,12278,12440,13142,13277,13736,13925,14114,14249,14330,14681,14762,15140,15410,15761,15788,15896,16949,17273,17894,19028,20027,22592,23402,23591,23699,23726,24158,25373,39278,41357,43112,43922,46568,51320,51914,52400,54479,55451,55937,59690,59744,59987,62633,65819,67169,67466,68438,71516,71921,72893,73541,73757,75242,75809,77213,77645,78833,79049,79508,80966,81479,83099,83207,84854,92846,94871,97,1285,1609,3985,5200,5740,6064,6577,7009,7225,7441,7657,7684,7765,7954,8224,8683,8737,8899,8953,9034,9277,9736,9871,10141,10168,10330,10465,11275,12436,13354,14245,14326,14866,15541,15622,15676,16675,16702,16837,17080,17242,17269,17323,17728,17917,27097,31876,38707,39490,43864,44998,46834,47968,48211,48589,49372,51856,52099,53611,53908,54907,55501,56905,57796,58471,63655,66031,67489,68272,68650,71782,73780,74779,76210,76939,77074,77344,79693,79747,81151,81475,88522,88846,804,1263,1776,1803,3639,3693,3855,3882,4989,5259,5664,7014,7662,7797,8121,8823,9363,9633,9903,10254,10578,11577,11739,12063,12090,13008,13224,13818,14007,14709,15303,16194,16437,16653,18111,18678,18759,18813,19407,21027,21486,21567,21702,22026,22377,23187,23484,25185,25266,26373,32340,38226,38955,45300,45921,51024,51321,51861,52914,52995,53751,54048,54534,54858,55101,56181,59448,61473,63741,65307,65361,65415,69654,72300,78267,79563,79779,80751,84369,86799,88365,89769,91227,93387,427,616,1912,3559,3667,4018,5044,6259,7393,7663,7798,8095,8608,8689,8770,8797,8986,9094,9310,9337,9688,10336,10633,11092,11335,11416,11767,11956,12847,12928,13009,13198,13630,13873,14791,14845,15304,15466,15790,16465,16924,19246,19570,19597,21136,21514,22162,22432,22459,23458,23539,23674,24997,25267,25969,27265,28453,30991,31558,36013,40306,41521,43006,43627,45733,46435,46462,47218,49324,50107,50512,53239,55507,57829,59044,62176,63958,64660,65200,67333,67576,67927,71356,76243,78619,80779,81184,81319,82237,84910,93334,94981,101893,921,1002,2001,2298,2784,3189,3513,3648,5160,5538,5592,6024,6267,7374,7833,8157,9156,10587,10857,10992,12018,12288,13827,13962,13989,14178,15663,15987,16419,16743,16905,17202,17472,17877,18525,18552,18903,19254,20172,20901,21009,21738,21819,22332,22737,22845,23439,23628,23709,23763,23817,24492,24519,24654,24816,25005,25896,27219,36642,39423,42825,46389,47388,47712,49197,50088,54813,56946,57108,59106,59160,60537,61779,65424,66072,68529,73794,75225,75792,77763,79356,80436,82488,86322,337,634,1039,1174,1633,1957,2335,2362,4144,5089,5413,5467,7303,7330,8248,8680,8734,8869,9301,9760,10138,10165,10408,10813,11245,11515,11893,12703,12919,12946,13648,13675,13810,14215,14404,14755,15295,15619,17536,18616,18805,20857,21127,21424,21748,21829,22045,22963,23449,23692,23827,25258,25582,25879,26311,31036,38137,42241,42457,46561,49369,50287,51286,51367,51745,60574,60979,61141,61789,63517,67972,71482,72265,72508,72940,73075,73318,75397,76612,77206,77422,77827,79798,80068,80500,81607,81877,85333,85846,86764,88708,90463,92029,93055,96025,1041,1176,1365,1851,2310,2391,5712,6252,6738,7305,7818,7845,8142,8223,8709,9438,9735,10221,10599,10626,11517,11760,12084,12246,12273,12354,12921,13056,13326,14001,14595,14649,14703,15378,16296,16971,18240,20805,22101,22236,22479,23532,25368,26259,28689,31362,37059,38139,39138,40893,41568,42891,46185,51369,51774,52341,53367,53907,55068,59118,64383,67353,71187,72699,72861,72915,80745,81906,81987,86847,88413,89061,509,995,1508,2615,3884,4073,4964,5261,5477,5720,5963,7124,7502,8042,8285,8636,9230,9797,9878,9959,10067,10202,10526,10553,10634,10688,10904,11039,11633,12146,12200,12794,12929,13469,13631,13928,14360,14414,14603,15305,15332,15845,15953,16412,16547,16790,17843,21839,22136,22163,22460,23135,23675,24431,26807,26861,27914,30452,31262,36338,36554,42872,43358,45275,46841,48191,48650,52592,55103,55346,55670,58829,60962,61745,62879,63689,67874,68009,71141,74705,75407,77594,78404,79565,79619,80402,80672,81050,84911,87314,88718,92012,93497,883,910,1315,1342,1909,3691,3745,4015,5527,5905,6148,6202,7687,8173,9793,9901,10009,10387,10414,11332,12547,12790,13222,13330,13600,14032,14059,14410,15328,15490,16030,16732,16867,17218,17947,19675,20593,20674,20863,20890,21565,21619,22861,23293,23455,23536,23914,24562,25885,26398,38143,40195,44434,45271,46027,51346,51373,51724,51859,52426,52885,53668,54208,54532,56665,56746,60796,61471,71461,73513,75106,75565,75781,76618,77509,77617,78967,80587,81721,83962,84907,86419,86446,89038,89416,93817,118,1360,1549,1630,1927,2143,2413,3196,3844,5140,6787,6841,6922,7651,7678,8650,8893,8947,9406,10324,10351,10459,10783,11080,11350,11755,12349,13564,14212,14347,15508,15805,15967,16048,16156,17506,17587,17830,18154,18208,19099,20476,23419,23689,24202,24310,24769,25147,26470,28954,30493,31438,34084,46288,48043,48637,49204,49987,51418,51472,52039,53902,55198,55684,57169,62110,63973,64027,65134,65836,67294,71020,72370,73396,73909,74017,74881,78229,79201,79498,79768,79957,80038,80497,81793,97804,918,945,1296,1512,1755,1836,1944,1998,3132,3780,5616,5967,5994,6237,6642,6696,7020,7344,7479,7668,8559,9234,10395,12177,12258,12852,13392,13473,13527,14256,14283,16497,16659,16713,17010,17523,17955,18090,19008,19386,19710,20493,20655,20925,21492,22302,22518,23733,25515,25785,25866,26514,31131,32157,32427,42930,45981,49545,50274,51003,56808,58563,61479,63369,66960,68391,72387,72657,73521,77517,79542,87318,92637,819,1116,1197,1224,1278,2196,2277,2844,3843,3897,4059,5166,5220,5760,5868,6111,6435,6867,7029,7083,7623,7866,8190,8298,8730,8784,9000,9783,9810,10026,10269,10296,10809,10890,11079,11322,11403,11457,11808,11916,12240,12564,13104,14346,14697,15588,16587,16614,16992,19665,20448,21123,21366,21987,22203,22419,22554,22662,23310,23796,24012,24066,25146,25308,32301,35973,42210,44856,47178,48123,49986,52443,52686,55899,56169,61164,62433,66726,66969,67158,71478,71667,71937,74205,75069,75609,77148,78012,78363,79227,79308,81711,89784,90162,93672,94752,362,1172,1361,1658,1901,3548,3602,3629,3737,3926,3953,5708,6815,7544,7922,7949,8327,8354,8705,8732,8759,9434,9623,9839,9866,10379,10649,10811,11297,11891,12215,12323,12998,13268,14645,14807,14942,15428,15536,15671,15752,15968,16130,16211,16319,16346,18020,19694,19964,20504,20558,24176,25985,28793,28820,29954,36191,40673,43076,44399,45263,47828,48017,50663,51176,53822,57386,59762,60248,62489,62894,62921,64190,67160,70967,71426,71534,73397,73613,79931,80606,81011,82280,83198,87977,88922,93782,99803,936,2340,5337,5607,6174,6633,6660,7254,7362,7767,7821,8010,8145,8199,8442,8658,8847,9225,9603,9900,10764,10791,11736,12951,13194,13302,13545,13626,14004,14166,15408,15570,15624,16542,16704,16893,16974,17055,17271,17541,17838,19431,19512,20808,21375,21780,22455,22968,23751,23778,24102,24723,24939,28935,31203,32337,41463,44406,46350,48213,48672,49833,50157,53181,53505,54909,57150,59121,59769,61119,61173,61389,63144,64359,67248,71973,73485,74241,75348,75564,76212,77103,77535,78318,78993,79479,79614,80964,81288,81315,81882,85554,86931,625,1057,1381,2218,2353,3622,3946,5296,5431,5566,5890,6187,6268,7240,7807,7888,8050,8320,8995,9184,9400,9427,9562,9724,9751,10453,10669,11290,11668,11911,11965,12181,12343,12667,12721,12856,13099,13261,13315,13612,14692,15394,15880,16528,16582,16717,17203,17392,18256,18391,21793,22522,22684,23035,24088,24304,24358,29893,41098,41557,45283,50251,50980,53815,55678,57136,57163,60889,61024,61429,64426,64723,67261,71581,71662,75145,77683,79708,80680,81112,92344,93532,1352,2054,2216,2270,2432,2729,3593,3944,3998,5321,5591,5888,6671,7562,7886,7967,9317,9506,10478,10910,11234,11288,12584,13178,13205,13529,13772,14285,14663,14717,15230,15527,15581,16013,16445,16580,16715,17039,17606,17741,17984,18011,18227,20144,20765,21521,21548,21899,22223,22250,22358,22871,22979,23276,23951,25976,26354,27056,28514,29621,36182,41150,42932,44741,52166,52382,56216,58214,62561,63911,67259,72632,75170,76898,77357,79193,79814,80165,80705,80732,83135,86321,87185,89264,91181,91586,91856,93935,950,1220,1274,1328,1382,1706,2381,2759,3623,4298,5351,5594,5675,5810,6242,6728,7430,7457,8213,8294,8942,9077,9239,9725,9833,9941,10076,11534,11831,12263,12722,12803,12830,12938,12965,12992,13127,13694,13721,14180,14531,14720,15638,15665,16340,16610,16637,17150,17285,17933,18014,18149,18743,18770,20633,21659,22118,23414,24008,25628,25898,27788,42584,45095,46391,48659,49739,54896,55895,56462,60269,66614,67100,67451,71042,71717,72365,73985,75146,78062,78278,80546,81248,83030,84488,94856,78,456,915,1671,1995,2211,3048,3507,3696,4047,4587,4803,4965,5478,5505,5586,5640,5856,6180,6936,7638,7800,8043,8124,8232,8313,8367,9393,9636,9825,9879,10068,10446,10743,11391,11526,12012,12255,12930,13902,14199,15819,18600,18654,19707,22488,22704,23406,23541,23757,24999,27429,31614,35097,39066,40416,53241,55212,57264,60774,62475,63393,64095,65796,67848,69360,72519,73221,78135,78243,79215,80673,81240,81969,82779,89826,90960,60,627,3516,3651,3975,4110,5649,6000,6270,6945,6999,7215,7512,8133,8781,9672,9753,10104,11292,11562,11913,12102,12183,12264,12426,12723,12939,13074,13182,13290,13371,14019,14343,14424,14694,14802,15531,15693,15774,15855,16557,16665,17097,17583,17637,18096,18339,22254,23253,23442,23793,24468,26952,30165,30273,36591,37158,41721,42774,43368,44880,48417,52494,53817,54897,55194,55518,57057,59838,60405,61404,62106,66021,66723,72204,74418,75147,77496,78657,79629,80709,81033,81087,85596,92751,24307,23705,77267,16885,16209,10865,12494,957,938,3037,22193,11516,12138,1676,11669,3489,829,2683,1605,22400,2187,229,978,1910,935,245,1005,3512,644,8517,10389,359,934,12602,5841,25338,9018,1600,1844,5255,3671,2279,9549,1586,1378,14429,1213,14303,234,670,725,1595,25251,2126,12479,8390,956,903";
	@Autowired
	private PartnerInstanceQueryService partnerInstanceQueryService;
	@Autowired
	private PartnerAssetService partnerAssetService;
	private static final Logger logger = LoggerFactory.getLogger(CloseTestServiceImpl.class);
	@Override
	public void test() {

   	 List<Long> ids = Stream.of(stationIds.split(",")).map(Long::parseLong).collect(Collectors.toList());
   	 List<String> results = Lists.newArrayList();
   	for (Iterator iterator = ids.iterator(); iterator.hasNext();) {
			Long stationId = (Long) iterator.next();
			try {
				results.add(queryPartnerInstance(stationId));
			} catch (Exception e) {
				logger.error("queryPartnerInstance error!"+stationId,e);
			}
		}
   	
   		results.stream().forEach(logger::error);
	}

	public String queryPartnerInstance(Long stationId){
   	 List<PartnerInstanceDto> instances = partnerInstanceQueryService.queryPartnerInstances(stationId);
   	 if(instances != null && instances.size()==1){
   		 PartnerInstanceCondition condition = new PartnerInstanceCondition();
   		 condition.setOperator("zhenhuan.zhangzh");
   		 condition.setOperatorType(OperatorTypeEnum.BUC);
   		 condition.setInstanceId(instances.get(0).getId());
   		 PartnerInstanceDto partnerInstanceDto = partnerInstanceQueryService.queryInfo(condition);
   		 boolean isAsssetBack = partnerAssetService.isBackAsset(instances.get(0).getId());
   		 return partnerInstanceDto.getStationId()+","+partnerInstanceDto.getState().getCode()+","+getBond(partnerInstanceDto.getPartnerLifecycleDto())+","+getRoleApprove(partnerInstanceDto.getPartnerLifecycleDto())+","+isAsssetBack;
   	 }else{
   		 instances  = instances.stream().filter(instance -> "n".equals(instance.getIsCurrent().getCode())).collect(Collectors.toList());
   		 PartnerInstanceCondition condition = new PartnerInstanceCondition();
   		 condition.setOperator("zhenhuan.zhangzh");
   		 condition.setOperatorType(OperatorTypeEnum.BUC);
   		 condition.setInstanceId(instances.get(0).getId());
   		 PartnerInstanceDto partnerInstanceDto = partnerInstanceQueryService.queryInfo(condition);
   		 boolean isAsssetBack = partnerAssetService.isBackAsset(instances.get(0).getId());
   		return partnerInstanceDto.getStationId()+","+partnerInstanceDto.getState().getCode()+","+getBond(partnerInstanceDto.getPartnerLifecycleDto())+","+getRoleApprove(partnerInstanceDto.getPartnerLifecycleDto())+","+isAsssetBack;
   	 }
   }
	
	String getBond(PartnerLifecycleDto lifeCycle){
		if(lifeCycle == null||lifeCycle.getBond() == null){
			return "";
		}
		return lifeCycle.getBond().getCode();
	}
	
	String getRoleApprove(PartnerLifecycleDto lifeCycle){
		if(lifeCycle == null||lifeCycle.getRoleApprove() == null){
			return "";
		}
		return lifeCycle.getRoleApprove().getCode();
	}
}
